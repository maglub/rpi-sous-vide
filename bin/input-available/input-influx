#!/bin/bash

this_dir=$(cd $(dirname $0);pwd)

. $this_dir/../conf/app.conf
. $this_dir/functions

#=====================================
# MAIN
#=====================================

initRelays

windowCount=0
windowCountMax=10

while true
do
  #res=$($this_dir/getTemperature)

  TS=$(date "+%Y%m%d_%H%M%S %s")

  curTemperature=$(getTemperature)
  setTemperatureToFile $curTemperature

  curSetpoint=$(getSetpointFromFile)
  curPumpStatus=$(getPumpStatus)
  curHeaterStatus=$(getHeaterStatus)

  printf "${TS} setpoint: %-6.2f temperature: %-6.2f pump: %-5s heater: %-5s\n" $curSetpoint $curTemperature $curPumpStatus $curHeaterStatus

  (( windowCount +=1 ))
  if [ $windowCount -ge $windowCountMax ]
  then
    windowCount=0
    $this_dir/write-influx smoker-setpoint $curSetpoint
    $this_dir/write-influx smoker-temp $curTemperature
  fi

  sleep 0.1
done
