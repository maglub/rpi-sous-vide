#!/bin/bash

this_dir=$(cd $(dirname $0);pwd)
this_script=$(basename $0)

. $this_dir/../conf/app.conf
. $this_dir/functions

#=====================================
# Functions
#=====================================
function doSetup(){

  #=============================================
  # This function will set up the 1wire requirements
  # when called
  #=============================================
  local rebootRequired=""

  #--- /boot/config.txt
  echo "* Checking /boot/config.txt"
  [ -z "$(grep -v "^#" /boot/config.txt | grep "dtoverlay=w1-gpio")" ] && {
    echo "  - Adding config to /boot/config.txt"
    echo "dtoverlay=w1-gpio" | sudo tee -a /boot/config.txt
    echo "  - Reboot required!"
    rebootRequired=true
  }

  #--- /boot/config.txt
  local module=""
  local modules="w1-gpio w1-therm"

  echo "* Checking /etc/modules"
  for module in $modules
  do
    [ -z "$(grep -v "^#" /etc/modules | grep $module)" ] && {
      echo "  - Adding module to module to /etc/modules"
      echo "$module" | sudo tee -a /etc/modules
      echo "  - Reboot required!"
      rebootRequired=true
    }
  done


  [ -n "$rebootRequired" ] && { echo ; echo "NOTE: Reboot required!" ; }

  return 0
}

#=====================================
# MAIN
#=====================================

if [ -n "$1" ]
then
  case $1 in
    --setup)
      echo "* Setup of requirements for $this_script"
      doSetup
      exit 0
    ;;
  esac
fi

#initRelays

windowCount=0
windowCountMax=10

while true
do
  TS=$(date "+%Y%m%d_%H%M%S %s")

  curTemperature=$(getTemperature)
  setTemperatureToFile $curTemperature

  printf "${TS} temperature: %-6.2f\n" $curTemperature
  sleep 0.1

  (( windowCount +=1 ))
  if [ $windowCount -ge $windowCountMax ]
  then
    windowCount=0
    $this_dir/logging smoker-temp $curTemperature
  fi

done
