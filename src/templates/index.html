{% extends "_layout.html" %}
{% from 'macros.html' import graphBox %}


{% block div %}
<style>
.graphItem.over {
  border: 2px dashed #000;
}
.graphItem.transparent, .graphItem.over {
  opacity: 0.4;
}

</style>


<div class="col-lg-4 col-sm-4">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading">Data</div>
          <div class="panel-body">
  
            <div class="row">
              <div class="col-lg-12">
  
                <ul>
                  <li><div id=temperature></div> 
                  <li><div id=setpoint></div>
                  <li><div id=heaterDuty></div>
                </ul>
  
              </div>
            </div>
            <div class="row">
              <div class="col-lg-12">
                <div id=gauge></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row"><!-- Set temperature -->
    <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading">Temprature Setpoint</div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-12">

              Current Setpoint: {{ setpoint }}<br><p>
              <form role="form" action="/config" method="POST">

                <input type="hidden" name="returnTo" value="root">

                <select name="temperature" class="form-control">
                  <option value=0 selected>0</option>
                  <option value=30>30</option>
                  <option value=40>40</option>
                  <option value=50>50</option>
                  <option value=60>60</option>
                  <option value=70>70</option>
                  <option value=75>75</option>
                  <option value=80>80</option>
                  <option value=85>85</option>
                  <option value=90>90</option>
                  <option value=95>95</option>
                  <option value=100>100</option>
                  <option value=110>110</option>
                  <option value=120>120</option>
                </select>

                <br><button type="submit" name="action" value="Temperature" class="btn btn-success">Set</button>

                <br><br>Quick sets<br>
                <button type="submit" name="action" value="Temperature0" class="btn btn-success">0</button>
                <button type="submit" name="action" value="Temperature70" class="btn btn-success">70</button>
                <button type="submit" name="action" value="Temperature80" class="btn btn-success">80</button>
                <button type="submit" name="action" value="Temperature90" class="btn btn-success">90</button>
                <button type="submit" name="action" value="Temperature100" class="btn btn-success">100</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="row"><!-- List processes -->
	<div class="col-lg-8">
		<div class="panel panel-default">
			<div class="panel-heading">Processes</div>
			<div class="panel-body">
                          <div class="table-responsive">
				<table class="table table-condensed table-hover"> 
					<thead>
						<tr>
							<th>Function</th>
							<th>Running</th>
							<th>Process Id</th>
						</tr>
					</thead>
					<tbody>
                                                <tr>
							<td>Input</td>
							<td>{{ processes['input']['status'] }}</td>
							<td>{{ processes['input']['pid'] }}</td>
                                                </tr>
                                                <tr>
							<td>Control</td>
							<td>{{ processes['control']['status'] }}</td>
							<td>{{ processes['control']['pid'] }}</td>
                                                </tr>
                                                <tr>
							<td>Output</td>
							<td>{{ processes['output']['status'] }}</td>
							<td>{{ processes['output']['pid'] }}</td>
                                                </tr>
					</tbody>
				</table>
                          </div>

                          <!-- Only visible if logged in -->
                          {% if isAuthenticated %}
                          {% endif %}
                          Start/stop processes:
                          <form role="form" action="/config" method="POST">
                            <input type="submit" name="action" value="Start" class="btn btn-success">
                            <input type="submit" name="action" value="Stop" class="btn btn-danger">
                            <input type="hidden" name="returnTo" value="root">
                          </form>

			</div>
		</div>
	</div>
</div>
</div>


{% endblock %}

{% block myjavascript %}

<script type="text/javascript">

var firstTime = true;

function updateStats(){

  var url="/api/all";
  d3.json(url, function(data){
      document.getElementById("temperature").innerHTML = "Temperature: " + data["temperature"];
      document.getElementById("setpoint").innerHTML = "Setpoint: " + data["setpoint"];
      document.getElementById("heaterDuty").innerHTML = "HeaterDuty: " + data["heaterDuty"];
      //drawBar(data);
      drawArc(data);
  });

  setTimeout('updateStats()', 5000);
}

function setupArc(){

//  var canvas = d3.select("#gauge").append("svg").attr("width",1000).attr("height",50).attr("id", "bar");
  // ugly centering of the gauge on an iphone
  var canvas = d3.select("#gauge").append("svg").attr("width",600).attr("height",200).append("g").attr("transform", "translate(145,100)").attr("id", "arc");

}

function drawBar(d){

  var data = [100, d["setpoint"], d["temperature"] ];
  var color = d3.scale.ordinal().range(["red", "blue", "orange"]);

  var canvas = d3.select("#bar");

  canvas.selectAll("rect").remove();

  var bars = canvas.selectAll("rect").data(data).enter()
               .append("rect")
               .attr("width", function(d) {return d * 10;})
               .attr("height", function(d,i){ return 50 - 10*i; } )
               .attr("y", function(d, i) { return 5*i; })
               .attr("fill", function(d, i) { return color(i);})
               .attr("id", function(d,i){ return "niklas"+i;});
}

function drawArc(d){

  //#--- we only need a bit of data from the json
  var data = [100, d["setpoint"], d["temperature"] ];
  var color = d3.scale.ordinal().range(["#ddd", "#d00", "#0d0"]);
  var arcScale = d3.scale.linear()
                   .domain([0,100])
                   .range([0,2*Math.PI]);

  var canvas = d3.select("#arc");
  canvas.selectAll("arc").remove();
  canvas.selectAll("path").remove();

  log.log("debug!");

  var arc = d3.svg.arc()
    .innerRadius(50)
    .outerRadius(100)
    .startAngle(0);

  canvas.append("path").datum({endAngle: arcScale(100)})
    .style("fill", color(0))
    .attr("d", arc)
    .attr("id", "path-background");
               
  canvas.append("path").datum({endAngle: arcScale(d["setpoint"]) })
    .style("fill", "#d00")
    .attr("d", arc)
    .attr("id", "path-setpoint");
               
  arc.innerRadius(55);
  arc.outerRadius(95);
  canvas.append("path").datum({endAngle: arcScale(d["temperature"]) })
    .style("fill", "#0d0")
    .attr("d", arc)
    .attr("id", "path-temperature");
               
  canvas.selectAll("text").remove();
  var addText = canvas.selectAll("text").data([ d["temperature"], d["setpoint"] ]).enter().append("text");
  var textElements = addText
      .attr("x", function(d,i){ return 0; })
      .attr("y", function(d,i){ return 15-i*20; })
      .text(function(d,i){ log.log(d); return d;})
      .attr("text-anchor", "middle")
      .attr("font-family", "Arial Black")
      .attr("font-size", "20px")
      .attr("fill", "black");

//  log.log("Temperature: " + d["temperature"] + " Setpoint: " + d["setpoint"] );
  return 0;
}


 $(document).ready(function(){
        setupArc();
	updateStats();
       //  drawArc(25,45);
 });



{% if isAuthenticated %}
{% endif %}

  </script>
{% endblock%}

